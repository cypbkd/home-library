{% extends "base.html" %}

{% block content %}
    <style>
        @media (max-width: 767.98px) {
            .books-grid > [class*="col-"] {
                flex: 0 0 100%;
                max-width: 100%;
            }

            .book-card {
                flex-direction: row;
            }

            .book-card .book-cover {
                width: 110px;
                height: 160px;
                object-fit: cover;
                border-top-right-radius: 0;
                border-bottom-left-radius: .25rem;
                flex-shrink: 0;
            }

            .book-card .card-body {
                display: flex;
                flex-direction: column;
                min-width: 0;
            }

            .book-card .card-title,
            .book-card .card-text {
                word-break: break-word;
            }

            .book-card .card-actions {
                margin-top: auto;
                display: flex;
                justify-content: flex-end;
                gap: .5rem;
            }

            .book-card .card-actions form {
                margin: 0;
            }
        }
    </style>

    <h1 class="mt-4 mb-4">My Books</h1>

    {% if books %}
        <div class="row books-grid">
            {% for user_book in books %}
            <div class="col-md-3 mb-4">  <!-- Changed to col-md-3 for larger cards, 4 per row -->
                <div class="card h-100 shadow-sm book-card"> <!-- Added shadow for depth -->
                    <!-- Sync Status Indicators -->
                    {% if user_book.sync_status == 'PENDING_SYNC' %}
                        <span class="badge badge-warning position-absolute m-2" style="top: 0; left: 0;">Pending Sync</span>
                    {% elif user_book.sync_status == 'SYNC_IN_PROGRESS' %}
                        <span class="badge badge-info position-absolute m-2" style="top: 0; left: 0;">Syncing...</span>
                    {% elif user_book.sync_status == 'SYNCED' %}
                        <span class="badge badge-success position-absolute m-2" style="top: 0; left: 0;">Synced</span>
                    {% elif user_book.sync_status == 'SYNC_FAILED' %}
                        <span class="badge badge-danger position-absolute m-2" style="top: 0; left: 0;">Sync Failed</span>
                        <!-- Manual Input Button for Sync Failed -->
                        <button type="button" class="btn btn-sm btn-danger position-absolute" style="top: 10px; right: 10px; z-index: 100;" data-toggle="modal" data-target="#manualInputModal-{{ user_book.id }}">Manual Input</button>

                        <!-- Modal for Manual Input -->
                        <div class="modal fade" id="manualInputModal-{{ user_book.id }}" tabindex="-1" role="dialog" aria-labelledby="manualInputModalLabel-{{ user_book.id }}" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="manualInputModalLabel-{{ user_book.id }}">Manually Input Book Details</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form action="/manual_update_book/{{ user_book.id }}" method="POST">
                                            <div class="form-group">
                                                <label for="title">Title</label>
                                                <input type="text" class="form-control" id="title" name="title" value="{{ user_book.book_item.title }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="author">Author</label>
                                                <input type="text" class="form-control" id="author" name="author" value="{{ user_book.book_item.author }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="genre">Genre</label>
                                                <input type="text" class="form-control" id="genre" name="genre" value="{{ user_book.book_item.genre if user_book.book_item.genre else '' }}">
                                            </div>
                                            <div class="form-group">
                                                <label for="description">Description</label>
                                                <textarea class="form-control" id="description" name="description" rows="3">{{ user_book.book_item.description if user_book.book_item.description else '' }}</textarea>
                                            </div>
                                            <div class="form-group">
                                                <label for="cover_image_url">Cover Image URL</label>
                                                <input type="url" class="form-control" id="cover_image_url" name="cover_image_url" value="{{ user_book.book_item.cover_image_url if user_book.book_item.cover_image_url else '' }}">
                                            </div>
                                            <div class="form-group">
                                                <label for="status">Reading Status</label>
                                                {% set current_status = user_book.status if user_book.status in ['to-read', 'reading', 'read'] else 'to-read' %}
                                                <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons" id="status">
                                                    <label class="btn btn-outline-secondary flex-fill {% if current_status == 'to-read' %}active{% endif %}">
                                                        <input type="radio" name="status" value="to-read" autocomplete="off" {% if current_status == 'to-read' %}checked{% endif %}> To Read
                                                    </label>
                                                    <label class="btn btn-outline-secondary flex-fill {% if current_status == 'reading' %}active{% endif %}">
                                                        <input type="radio" name="status" value="reading" autocomplete="off" {% if current_status == 'reading' %}checked{% endif %}> Reading
                                                    </label>
                                                    <label class="btn btn-outline-secondary flex-fill {% if current_status == 'read' %}active{% endif %}">
                                                        <input type="radio" name="status" value="read" autocomplete="off" {% if current_status == 'read' %}checked{% endif %}> Read
                                                    </label>
                                                </div>
                                            </div>
                                            <div class="form-group">
                                                <label for="rating">Rating (1-5)</label>
                                                <input type="number" class="form-control" id="rating" name="rating" min="1" max="5" value="{{ user_book.rating if user_book.rating else '' }}">
                                            </div>
                                            <button type="submit" class="btn btn-primary">Update Details</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}

                    {% if user_book.book_item.cover_image_url %}
                        <img src="{{ user_book.book_item.cover_image_url }}" class="card-img-top book-cover" alt="Book Cover" style="height: 250px; object-fit: cover;"> <!-- Fixed height for covers -->
                    {% else %}
                        <img src="https://via.placeholder.com/150x250?text=No+Cover" class="card-img-top book-cover" alt="No Cover Available" style="height: 250px; object-fit: cover;">
                    {% endif %}
                    <div class="card-body d-flex flex-column">
                        <h5 class="card-title text-truncate">{{ user_book.book_item.title }}</h5> <!-- Truncate long titles -->
                        <p class="card-text text-muted mb-2">{{ user_book.book_item.author }}</p> <!-- Author with muted style -->
                        {% if user_book.book_item.description %}
                            <p class="card-text small text-muted flex-grow-1" style="max-height: 75px; overflow: hidden;">{{ user_book.book_item.description }}</p> <!-- Short description -->
                        {% endif %}
                        <ul class="list-group list-group-flush mt-auto">
                            <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                                <span>Status:</span>
                                <span class="badge badge-secondary">{{ user_book.status }}</span>
                            </li>
                            {% if user_book.rating %}
                            <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                                <span>Rating:</span>
                                <span>{{ user_book.rating }}/5</span>
                            </li>
                            {% endif %}
                            <li class="list-group-item d-flex justify-content-between align-items-center p-1">
                                <small class="text-muted">Added:</small>
                                <small class="text-muted">
                                    {% if user_book.date_added is string %}
                                        {{ user_book.date_added[:10] }}
                                    {% elif user_book.date_added %}
                                        {{ user_book.date_added.strftime('%Y-%m-%d') }}
                                    {% endif %}
                                </small>
                            </li>
                        </ul>
                        <div class="card-actions mt-3">
                            <a href="{{ url_for('edit_book', user_book_id=user_book.id) }}" class="btn btn-outline-primary btn-sm">Edit</a>
                            <form action="{{ url_for('delete_book', user_book_id=user_book.id) }}" method="POST" style="display: inline-block;">
                                <button type="submit" class="btn btn-outline-danger btn-sm" onclick="return confirm('Are you sure you want to delete this book?');">Delete</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p>You haven't added any books yet. <a href="/add_book">Add one now!</a></p>
    {% endif %}
{% endblock %}
