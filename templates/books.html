{% extends "base.html" %}
{% block content %}
    <h1 class="mt-4 mb-4">My Books</h1>
    {% if books %}
        <div class="row">
            {% for user_book in books %}
            <div class="col-md-4 mb-4">
                <div class="card h-100 position-relative">
                    {% if user_book.sync_status == 'PENDING_SYNC' %}
                        <i class="fas fa-hourglass-half text-warning position-absolute" style="top: 10px; left: 10px; font-size: 1.5rem;"></i>
                    {% elif user_book.sync_status == 'SYNC_IN_PROGRESS' %}
                        <i class="fas fa-sync-alt text-info position-absolute" style="top: 10px; left: 10px; font-size: 1.5rem;"></i>
                    {% elif user_book.sync_status == 'SYNCED' %}
                        <i class="fas fa-check-circle text-success position-absolute" style="top: 10px; left: 10px; font-size: 1.5rem;"></i>
                    {% elif user_book.sync_status == 'SYNC_FAILED' %}
                        <i class="fas fa-exclamation-triangle text-danger position-absolute" style="top: 10px; left: 10px; font-size: 1.5rem;"></i>
                        <button type="button" class="btn btn-sm btn-danger position-absolute" style="top: 10px; right: 10px;" data-toggle="modal" data-target="#manualInputModal-{{ user_book.id }}">Manual Input</button>

                        <!-- Modal for Manual Input -->
                        <div class="modal fade" id="manualInputModal-{{ user_book.id }}" tabindex="-1" role="dialog" aria-labelledby="manualInputModalLabel-{{ user_book.id }}" aria-hidden="true">
                            <div class="modal-dialog" role="document">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title" id="manualInputModalLabel-{{ user_book.id }}">Manually Input Book Details</h5>
                                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                            <span aria-hidden="true">&times;</span>
                                        </button>
                                    </div>
                                    <div class="modal-body">
                                        <form action="/manual_update_book/{{ user_book.id }}" method="POST">
                                            <div class="form-group">
                                                <label for="title">Title</label>
                                                <input type="text" class="form-control" id="title" name="title" value="{{ user_book.book_item.title }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="author">Author</label>
                                                <input type="text" class="form-control" id="author" name="author" value="{{ user_book.book_item.author }}" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="genre">Genre</label>
                                                <input type="text" class="form-control" id="genre" name="genre" value="{{ user_book.book_item.genre if user_book.book_item.genre else '' }}">
                                            </div>
                                            <div class="form-group">
                                                <label for="description">Description</label>
                                                <textarea class="form-control" id="description" name="description" rows="3">{{ user_book.book_item.description if user_book.book_item.description else '' }}</textarea>
                                            </div>
                                            <div class="form-group">
                                                <label for="cover_image_url">Cover Image URL</label>
                                                <input type="url" class="form-control" id="cover_image_url" name="cover_image_url" value="{{ user_book.book_item.cover_image_url if user_book.book_item.cover_image_url else '' }}">
                                            </div>
                                            <div class="form-group">
                                                <label for="status">Reading Status</label>
                                                <select class="form-control" id="status" name="status">
                                                    <option value="to-read" {% if user_book.status == 'to-read' %}selected{% endif %}>To Read</option>
                                                    <option value="reading" {% if user_book.status == 'reading' %}selected{% endif %}>Reading</option>
                                                    <option value="read" {% if user_book.status == 'read' %}selected{% endif %}>Read</option>
                                                </select>
                                            </div>
                                            <div class="form-group">
                                                <label for="rating">Rating (1-5)</label>
                                                <input type="number" class="form-control" id="rating" name="rating" min="1" max="5" value="{{ user_book.rating if user_book.rating else '' }}">
                                            </div>
                                            <button type="submit" class="btn btn-primary">Update Details</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    {% if user_book.book_item.cover_image_url %}
                        <img src="{{ user_book.book_item.cover_image_url }}" class="card-img-top" alt="Book Cover">
                    {% else %}
                        <img src="https://via.placeholder.com/150" class="card-img-top" alt="No Cover Available">
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">{{ user_book.book_item.title }}</h5>
                        <p class="card-text"><strong>Author:</strong> {{ user_book.book_item.author }}</p>
                        <p class="card-text"><strong>ISBN:</strong> {{ user_book.book_item.isbn }}</p>
                        <p class="card-text"><strong>Status:</strong> {{ user_book.status }}</p>
                        {% if user_book.rating %}
                            <p class="card-text"><strong>Rating:</strong> {{ user_book.rating }}/5</p>
                        {% endif %}
                        <p class="card-text"><small class="text-muted">Added on: {{ user_book.date_added.strftime('%Y-%m-%d') }}</small></p>
                    </div>
                    <div class="card-footer">
                        <a href="{{ url_for('edit_book', user_book_id=user_book.id) }}" class="btn btn-info btn-sm">Edit</a>
                        <a href="#" class="btn btn-danger btn-sm">Delete</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <p>You haven't added any books yet. <a href="/add_book">Add one now!</a></p>
    {% endif %}
{% endblock %}