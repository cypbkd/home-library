{% extends "base.html" %}
{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mt-4 mb-4">Add New Book</h1>

            <!-- ISBN Scanner Section -->
            <div class="card mb-4">
                <div class="card-header">
                    Automatic ISBN Scan
                </div>
                <div class="card-body text-center">
                    <div id="scanner-container">
                        <video id="video" width="100%" height="auto" autoplay></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                    </div>
                    <div id="scan-result" class="mt-3">Starting automatic scan...</div>
                </div>
            </div>

            <form method="POST" action="/add_book">
                <div class="form-group">
                    <label for="isbn">ISBN (10 or 13 digits)</label>
                    <input type="text" class="form-control" id="isbn" name="isbn" placeholder="e.g., 978-0321765723" readonly>
                    <small class="form-text text-muted">ISBN is automatically detected. You can manually override if needed.</small>
                </div>
                <div class="form-group">
                    <label for="title">Title (Optional)</label>
                    <input type="text" class="form-control" id="title" name="title">
                </div>
                <div class="form-group">
                    <label for="author">Author (Optional)</label>
                    <input type="text" class="form-control" id="author" name="author">
                </div>
                <div class="form-group">
                    <label for="genre">Genre (Optional)</label>
                    <input type="text" class="form-control" id="genre" name="genre">
                </div>
                <div class="form-group">
                    <label for="cover_image_url">Cover Image URL (Optional)</label>
                    <input type="url" class="form-control" id="cover_image_url" name="cover_image_url">
                </div>
                <div class="form-group">
                    <label for="description">Description (Optional)</label>
                    <textarea class="form-control" id="description" name="description" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <div class="btn-group btn-group-toggle d-flex" data-toggle="buttons" id="status">
                        <label class="btn btn-outline-secondary active flex-fill">
                            <input type="radio" name="status" value="to-read" autocomplete="off" checked> To Read
                        </label>
                        <label class="btn btn-outline-secondary flex-fill">
                            <input type="radio" name="status" value="reading" autocomplete="off"> Reading
                        </label>
                        <label class="btn btn-outline-secondary flex-fill">
                            <input type="radio" name="status" value="read" autocomplete="off"> Read
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label>Rating (Optional)</label>
                    <div id="star-rating-add" class="star-rating"></div>
                </div>
                <button type="submit" class="btn btn-primary">Add Book</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.8.2/dist/quagga.min.js"></script>
    <script>
        const scannerContainer = document.getElementById('scanner-container');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const isbnInput = document.getElementById('isbn');
        const scanResult = document.getElementById('scan-result');
        let stream;
        let scanning = false;
        let scanInterval;
        let barcodeDetector = null;
        let isDecodingFrame = false;
        let useQuaggaFallback = false;

        function normalizeIsbn(value) {
            return String(value || '').replace(/[-\s]/g, '');
        }

        function isValidIsbn(value) {
            const isbn = normalizeIsbn(value);
            return (isbn.length === 10 || isbn.length === 13) && /^\d+$/.test(isbn);
        }

        async function setupDecoder() {
            if ('BarcodeDetector' in window) {
                try {
                    barcodeDetector = new BarcodeDetector({
                        formats: ['ean_13', 'ean_8', 'upc_a', 'upc_e', 'code_128']
                    });
                    scanResult.textContent = 'Camera active. Barcode detector ready.';
                    return;
                } catch (error) {
                    console.warn('BarcodeDetector init failed, falling back to Quagga.', error);
                }
            }

            if (typeof Quagga !== 'undefined') {
                useQuaggaFallback = true;
                scanResult.textContent = 'Camera active. Using fallback barcode decoder.';
                return;
            }

            scanResult.textContent = 'Barcode scanning is not supported in this browser. Enter ISBN manually.';
            scanning = false;
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await startScan();
        });

        async function startScan() {
            scanResult.textContent = 'Starting camera...';
            scanning = true;

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.play();
                scanResult.textContent = 'Camera active. Preparing barcode scanner...';

                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    setupDecoder().then(() => {
                        if (!scanning) {
                            return;
                        }
                        scanInterval = setInterval(captureAndScan, 250);
                    });
                };

            } catch (err) {
                console.error("Error accessing camera: ", err);
                scanResult.textContent = 'Error accessing camera. Please ensure camera permissions are granted and refresh.';
                scanning = false;
            }
        }

        function stopScan(options = {}) {
            const { preserveStatus = false } = options;
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            if (scanInterval) {
                clearInterval(scanInterval);
            }
            scanning = false;
            if (!preserveStatus) {
                scanResult.textContent = 'Scan stopped.';
                scanResult.classList.remove('text-success', 'text-danger');
            }
        }

        async function decodeWithBarcodeDetector() {
            if (!barcodeDetector) {
                return null;
            }

            const detections = await barcodeDetector.detect(canvas);
            for (const detection of detections) {
                if (isValidIsbn(detection.rawValue)) {
                    return normalizeIsbn(detection.rawValue);
                }
            }
            return null;
        }

        function decodeWithQuagga(imageData) {
            if (!useQuaggaFallback) {
                return Promise.resolve(null);
            }

            return new Promise((resolve) => {
                Quagga.decodeSingle({
                    src: imageData,
                    numOfWorkers: 0,
                    inputStream: { size: 800 },
                    decoder: {
                        readers: ['ean_reader', 'ean_8_reader', 'upc_reader', 'upc_e_reader', 'code_128_reader']
                    }
                }, (result) => {
                    const code = result && result.codeResult ? result.codeResult.code : null;
                    if (isValidIsbn(code)) {
                        resolve(normalizeIsbn(code));
                        return;
                    }
                    resolve(null);
                });
            });
        }

        async function captureAndScan() {
            if (!scanning || video.paused || video.ended || isDecodingFrame) {
                return;
            }

            isDecodingFrame = true;
            const context = canvas.getContext('2d');
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Only update status if no ISBN is found yet
            if (!isbnInput.value) {
                scanResult.classList.remove('text-success', 'text-danger');
                scanResult.textContent = 'Scanning for ISBN...';
            }

            try {
                const imageData = canvas.toDataURL('image/png');
                let scannedIsbn = await decodeWithBarcodeDetector();
                if (!scannedIsbn) {
                    scannedIsbn = await decodeWithQuagga(imageData);
                }
                if (!scannedIsbn) {
                    return;
                }

                const response = await fetch('/scan_isbn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ isbn: scannedIsbn })
                });

                const data = await response.json();

                if (data.success && data.isbn) {
                    isbnInput.value = data.isbn;
                    scanResult.classList.remove('text-info'); // Remove initial info class
                    scanResult.classList.add('text-success'); // Add green class
                    scanResult.textContent = `ISBN Scanned: ${data.isbn}. Book will be added automatically in 3 seconds.`;
                    stopScan({ preserveStatus: true }); // Stop scanning once ISBN is found

                    // Auto-submit after 3 seconds
                    setTimeout(() => {
                        document.querySelector('form').submit();
                    }, 3000);

                } else if (response.status === 409) {
                    stopScan({ preserveStatus: true });
                    scannerContainer.style.display = 'none';
                    scanResult.classList.remove('text-success', 'text-info');
                    scanResult.classList.add('text-danger');
                    scanResult.textContent = data.message || 'Book already in your library.';

                } else if (!isbnInput.value) { // Only update if no ISBN is found yet
                    scanResult.classList.remove('text-success');
                    scanResult.classList.add('text-info');
                    scanResult.textContent = data.message || 'No valid ISBN barcode found yet. Keep trying...';
                }
            } catch (error) {
                console.error('Error scanning ISBN:', error);
                if (!isbnInput.value) { // Only update if no ISBN is found yet
                    scanResult.classList.remove('text-success');
                    scanResult.classList.add('text-danger'); // Use danger for errors
                    scanResult.textContent = 'Error during ISBN scan. Retrying...';
                }
            } finally {
                isDecodingFrame = false;
            }
        }
    </script>
{% endblock %}
