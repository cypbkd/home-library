{% extends "base.html" %}
{% block content %}
    <div class="row justify-content-center">
        <div class="col-md-8">
            <h1 class="mt-4 mb-4">Add New Book</h1>

            <!-- ISBN Scanner Section -->
            <div class="card mb-4">
                <div class="card-header">
                    Scan ISBN
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-info mb-3" id="start-scan-btn">Start ISBN Scan</button>
                    <div id="scanner-container" style="display: none;">
                        <video id="video" width="100%" height="auto" autoplay></video>
                        <canvas id="canvas" style="display: none;"></canvas>
                        <button type="button" class="btn btn-success mt-3" id="capture-btn">Capture ISBN</button>
                        <button type="button" class="btn btn-danger mt-3" id="stop-scan-btn">Stop Scan</button>
                    </div>
                    <div id="scan-result" class="mt-3"></div>
                </div>
            </div>

            <form method="POST" action="/add_book">
                <div class="form-group">
                    <label for="isbn">ISBN (10 or 13 digits)</label>
                    <input type="text" class="form-control" id="isbn" name="isbn" placeholder="e.g., 978-0321765723" required>
                    <small class="form-text text-muted">ISBN is used to uniquely identify the book. We'll try to fetch details based on it.</small>
                </div>
                <div class="form-group">
                    <label for="title">Title</label>
                    <input type="text" class="form-control" id="title" name="title" required>
                </div>
                <div class="form-group">
                    <label for="author">Author</label>
                    <input type="text" class="form-control" id="author" name="author" required>
                </div>
                <div class="form-group">
                    <label for="genre">Genre (Optional)</label>
                    <input type="text" class="form-control" id="genre" name="genre">
                </div>
                <div class="form-group">
                    <label for="cover_image_url">Cover Image URL (Optional)</label>
                    <input type="url" class="form-control" id="cover_image_url" name="cover_image_url">
                </div>
                <div class="form-group">
                    <label for="description">Description (Optional)</label>
                    <textarea class="form-control" id="description" name="description" rows="5"></textarea>
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select class="form-control" id="status" name="status">
                        <option value="to-read">To Read</option>
                        <option value="reading">Reading</option>
                        <option value="read">Read</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Rating (Optional)</label>
                    <div id="star-rating-add" class="star-rating"></div>
                </div>
                <button type="submit" class="btn btn-primary">Add Book</button>
            </form>
        </div>
    </div>

    <script>
        const startScanBtn = document.getElementById('start-scan-btn');
        const stopScanBtn = document.getElementById('stop-scan-btn');
        const captureBtn = document.getElementById('capture-btn');
        const scannerContainer = document.getElementById('scanner-container');
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const isbnInput = document.getElementById('isbn');
        const scanResult = document.getElementById('scan-result');
        let stream;

        startScanBtn.addEventListener('click', async () => {
            scannerContainer.style.display = 'block';
            startScanBtn.style.display = 'none';
            scanResult.textContent = 'Starting camera...';

            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                video.srcObject = stream;
                video.play();
                scanResult.textContent = 'Camera active. Position ISBN in view and click "Capture ISBN".';
            } catch (err) {
                console.error("Error accessing camera: ", err);
                scanResult.textContent = 'Error accessing camera. Please ensure camera permissions are granted.';
                scannerContainer.style.display = 'none';
                startScanBtn.style.display = 'block';
            }
        });

        stopScanBtn.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
            }
            scannerContainer.style.display = 'none';
            startScanBtn.style.display = 'block';
            scanResult.textContent = '';
        });

        captureBtn.addEventListener('click', async () => {
            if (!stream) {
                scanResult.textContent = 'Camera not active. Please start the scan first.';
                return;
            }

            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/png'); // Get image data as base64

            scanResult.textContent = 'Scanning for ISBN...';

            try {
                const response = await fetch('/scan_isbn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ image: imageData })
                });

                const data = await response.json();

                if (data.isbn) {
                    isbnInput.value = data.isbn;
                    scanResult.textContent = `ISBN Scanned: ${data.isbn}`;
                    // Optionally stop the camera after a successful scan
                    if (stream) {
                        stream.getTracks().forEach(track => track.stop());
                        video.srcObject = null;
                    }
                    scannerContainer.style.display = 'none';
                    startScanBtn.style.display = 'block';
                } else {
                    scanResult.textContent = data.message || 'No ISBN found in the image.';
                }
            } catch (error) {
                console.error('Error scanning ISBN:', error);
                scanResult.textContent = 'Error during ISBN scan.';
            }
        });
    </script>
{% endblock %}